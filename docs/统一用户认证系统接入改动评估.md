# 统一用户认证系统接入改动评估

## 一、当前系统架构分析

### 1.1 认证架构
- **认证方式**：Django REST Framework SimpleJWT (JWT Token认证)
- **用户模型**：自定义 `User` 模型（继承 `AbstractUser`）
- **认证流程**：用户名/密码登录 → 获取 JWT Token → 使用 Token 访问 API
- **Token存储**：前端存储在 localStorage，请求时通过 `Authorization: Bearer <token>` 传递

### 1.2 用户模型特点
```python
# backend/apps/accounts/models.py
class User(AbstractUser):
    role = models.CharField(...)  # 'user', 'admin', 'manager', 'employee'
    phone = models.CharField(...)
    department = models.CharField(...)
    avatar = models.ImageField(...)
```

### 1.3 权限控制方式
- **角色定义**：使用方(user)、管理方(admin)、项目经理(manager)、员工(employee)
- **权限检查**：在视图中直接使用 `request.user.is_admin`、`user.role` 等属性
- **数据过滤**：根据用户角色在 `get_queryset()` 中过滤数据

## 二、改动影响范围评估

### 2.1 核心改动模块（必须修改）

#### A. 认证模块（高影响度）
**文件：**
- `backend/apps/accounts/views.py` - 登录视图需要完全重构
- `backend/apps/accounts/urls.py` - 可能需要调整路由
- `backend/oms_backend/settings.py` - 认证配置需要修改

**改动内容：**
1. 替换登录逻辑：从本地用户名/密码验证改为调用统一认证系统API
2. 调整Token获取方式：可能改为从统一认证系统获取Token，或继续使用本地JWT但通过统一认证系统验证用户
3. 修改认证中间件：可能需要自定义认证后端来对接统一认证系统

**预估工作量：** 2-3 天

#### B. 用户模型（高影响度）
**文件：**
- `backend/apps/accounts/models.py` - 用户模型可能需要调整

**改动内容：**
1. 用户数据同步：
   - 方案A（推荐）：保留本地User模型作为缓存/扩展，通过同步机制从统一认证系统同步用户数据
   - 方案B：完全移除本地用户表，所有用户数据从统一认证系统实时查询
2. 关联关系处理：需要确保Task、WorkflowLog、Notification等模型的外键关联正常工作
3. 角色映射：需要建立统一认证系统的角色与本系统角色的映射关系

**预估工作量：** 
- 方案A：3-4 天
- 方案B：5-7 天（风险较高，涉及大量数据迁移）

#### C. 权限控制逻辑（中高影响度）
**文件：**
- `backend/apps/tasks/views.py` - 多处权限检查逻辑
- 其他可能使用 `request.user` 的视图文件

**改动内容：**
1. 角色判断方式调整：可能需要从统一认证系统获取角色信息
2. 权限缓存：如果用户信息来自外部系统，需要考虑缓存机制以提高性能

**预估工作量：** 2-3 天

### 2.2 数据关联模块（中等影响度）

#### A. 任务相关模型
**文件：**
- `backend/apps/tasks/models.py` - Task模型的用户外键字段
- 相关的序列化器和视图

**改动内容：**
- `creator`、`reviewer`、`assignee`、`handler`、`assistant_employees` 等外键字段
- 如果采用方案B（完全移除本地用户表），需要进行数据迁移
- 如果采用方案A（保留本地用户表），需要确保用户同步机制正常工作

**预估工作量：** 1-2 天

#### B. 工作流相关模型
**文件：**
- `backend/apps/workflow/models.py` - WorkflowLog、Notification、SmsRecord模型

**改动内容：**
- 用户外键字段的处理
- 短信发送逻辑中的用户查询（需要确保能通过统一认证系统查询到用户）

**预估工作量：** 1 天

### 2.3 前端改动（中等影响度）

#### A. 登录页面
**文件：**
- `frontend-pc/src/pages/Login.jsx`
- `frontend-miniprogram/pages/login/login.js`

**改动内容：**
- 可能需要调整登录API调用方式
- 如果统一认证系统使用OAuth/OIDC，可能需要跳转到统一认证系统页面

**预估工作量：** 1-2 天

#### B. 用户信息管理
**文件：**
- `frontend-pc/src/store/authStore.js` - 用户信息存储方式
- `frontend-pc/src/components/Layout.jsx` - 用户信息显示

**改动内容：**
- Token存储和使用方式
- 用户信息获取方式（可能不再从登录响应直接获取）

**预估工作量：** 0.5-1 天

### 2.4 管理后台（中等影响度）

#### A. Django Admin用户管理
**文件：**
- `backend/apps/accounts/admin.py`

**改动内容：**
- 用户创建/编辑/删除功能可能需要禁用或改为同步操作
- 如果采用方案A，可能需要添加用户同步按钮/自动同步机制

**预估工作量：** 1-2 天

#### B. 后台用户管理API
**文件：**
- `backend/apps/accounts/views.py` - UserViewSet

**改动内容：**
- 用户列表可能需要从统一认证系统获取
- 用户创建/编辑/删除操作可能需要调用统一认证系统API

**预估工作量：** 1-2 天

### 2.5 配置文件（低影响度）

**文件：**
- `backend/oms_backend/settings.py`
- `backend/requirements.txt`（可能需要添加新的认证库）
- `docs/部署说明.md`（更新部署配置）

**改动内容：**
- 添加统一认证系统相关配置（API地址、密钥等）
- 更新认证后端配置
- 文档更新

**预估工作量：** 0.5 天

## 三、具体改动清单

### 3.1 必须修改的核心文件

| 文件路径 | 改动类型 | 预估工作量 | 优先级 |
|---------|---------|-----------|--------|
| `backend/apps/accounts/views.py` | 重构 | 2-3天 | P0 |
| `backend/apps/accounts/models.py` | 调整 | 2-4天 | P0 |
| `backend/oms_backend/settings.py` | 配置 | 0.5天 | P0 |
| `backend/apps/tasks/views.py` | 调整 | 2-3天 | P0 |
| `backend/apps/accounts/admin.py` | 调整 | 1-2天 | P1 |
| `backend/apps/accounts/urls.py` | 调整 | 0.5天 | P1 |

### 3.2 需要适配的视图文件

| 文件路径 | 改动内容 | 预估工作量 | 优先级 |
|---------|---------|-----------|--------|
| `backend/apps/workflow/views.py` | 用户查询适配 | 0.5天 | P1 |
| `backend/apps/workflow/sms_service.py` | 用户查询适配 | 0.5天 | P1 |
| `backend/apps/tasks/views.py` | 权限检查适配 | 已包含在核心改动 | - |

### 3.3 前端改动文件

| 文件路径 | 改动内容 | 预估工作量 | 优先级 |
|---------|---------|-----------|--------|
| `frontend-pc/src/pages/Login.jsx` | 登录流程调整 | 1天 | P0 |
| `frontend-pc/src/store/authStore.js` | Token管理调整 | 0.5天 | P0 |
| `frontend-miniprogram/pages/login/login.js` | 登录流程调整 | 1天 | P1 |

### 3.4 新增文件（可能需要）

| 文件路径 | 说明 | 预估工作量 |
|---------|------|-----------|
| `backend/apps/accounts/auth_backend.py` | 自定义认证后端 | 1-2天 |
| `backend/apps/accounts/sync_service.py` | 用户同步服务 | 2-3天 |
| `backend/apps/accounts/migrations/xxxx_sync_user_changes.py` | 数据迁移文件 | 1天 |

## 四、技术方案建议

### 4.1 推荐方案：混合模式（方案A）

**核心思路：**
- 保留本地User模型作为缓存和扩展字段存储
- 通过同步机制从统一认证系统同步用户数据
- 认证验证通过统一认证系统完成
- 本地存储用户的扩展信息（如角色映射、部门等）

**优点：**
- 改动相对较小
- 性能较好（用户数据本地缓存）
- 可以保留现有的业务逻辑
- 支持离线场景

**缺点：**
- 需要维护用户同步机制
- 可能存在数据一致性问题

**实现要点：**
1. 创建用户同步服务，定期或实时同步用户数据
2. 自定义认证后端，调用统一认证系统验证用户
3. 在登录时自动同步用户信息到本地

### 4.2 备选方案：完全外部化（方案B）

**核心思路：**
- 移除本地User模型
- 所有用户查询都从统一认证系统获取
- 任务等业务数据通过用户ID关联（不建立外键）

**优点：**
- 用户数据完全统一管理
- 无需维护同步机制

**缺点：**
- 改动量巨大
- 需要大量数据迁移
- 性能可能受影响（每次都需要查询外部系统）
- 风险较高

**不推荐使用此方案，除非有特殊要求。**

## 五、风险评估

### 5.1 高风险项

1. **数据迁移风险**
   - 如果现有系统中已有大量任务数据，迁移用户关联关系时可能出现数据丢失
   - **缓解措施**：充分备份数据库，编写详细的数据迁移脚本和回滚方案

2. **性能风险**
   - 如果频繁调用统一认证系统API，可能影响系统性能
   - **缓解措施**：实施用户信息缓存机制，减少外部API调用

3. **业务中断风险**
   - 切换认证系统可能导致现有用户无法登录
   - **缓解措施**：实施灰度发布，保留双认证模式过渡期

### 5.2 中风险项

1. **角色映射问题**
   - 统一认证系统的角色可能与本系统角色不完全一致
   - **缓解措施**：建立明确的角色映射表和转换逻辑

2. **用户扩展字段**
   - 统一认证系统可能不包含本系统需要的所有用户字段（如部门、头像等）
   - **缓解措施**：保留本地用户扩展表，存储统一认证系统不包含的字段

## 六、工作量汇总

### 6.1 开发工作量估算

| 模块 | 预估工作量 | 备注 |
|-----|-----------|------|
| 认证模块重构 | 2-3天 | 核心改动 |
| 用户模型调整 | 2-4天 | 根据方案选择 |
| 权限控制适配 | 2-3天 | 涉及多个视图 |
| 用户同步服务 | 2-3天 | 方案A需要 |
| 数据迁移脚本 | 1-2天 | 根据方案选择 |
| 前端登录适配 | 1-2天 | PC端+小程序端 |
| 管理后台调整 | 1-2天 | Admin界面 |
| 测试与调试 | 3-5天 | 全流程测试 |
| 文档更新 | 0.5天 | 部署说明等 |

**总计：15-26天（按方案A估算）**

### 6.2 分阶段实施建议

**阶段一：准备与验证（3-5天）**
- 与统一认证系统对接，获取API文档和测试环境
- 编写用户同步服务原型
- 编写数据迁移脚本（测试环境验证）

**阶段二：核心功能开发（7-10天）**
- 重构认证模块
- 调整用户模型和权限控制
- 实现用户同步机制

**阶段三：前端与界面调整（2-3天）**
- 前端登录页面调整
- 管理后台调整

**阶段四：测试与优化（3-5天）**
- 功能测试
- 性能测试
- Bug修复
- 文档完善

**阶段五：上线部署（1-2天）**
- 数据迁移
- 生产环境配置
- 灰度发布
- 监控与回滚准备

## 七、关键依赖与前置条件

### 7.1 需要统一认证系统提供的信息

1. **API接口文档**
   - 用户认证接口（登录验证）
   - 用户信息查询接口
   - Token获取/刷新接口（如果使用统一认证系统的Token）
   - 用户列表/搜索接口

2. **技术规范**
   - 认证协议类型（OAuth2/OIDC/JWT/自定义）
   - Token格式和有效期
   - API调用频率限制
   - 错误码定义

3. **角色体系**
   - 统一认证系统的角色定义
   - 角色与本系统角色的映射关系

4. **测试环境**
   - 测试账号和权限
   - 测试环境地址和配置

### 7.2 需要确认的技术细节

1. 统一认证系统支持的认证协议（OAuth2/OIDC/SAML/自定义）
2. 是否需要在统一认证系统中配置本系统作为客户端
3. Token格式和验证方式
4. 用户信息同步方式（推送/拉取/实时查询）
5. 是否支持用户扩展字段存储

## 八、总结

### 8.1 改动量评估

**总体评估：中等偏高改动量**

- **核心改动文件**：约 10-15 个文件需要修改
- **新增文件**：约 2-4 个新服务/工具类
- **数据迁移**：可能需要数据库迁移脚本
- **总工作量**：15-26 个工作日（约 3-5 周）

### 8.2 建议

1. **采用混合模式（方案A）**：在保留本地用户模型的基础上对接统一认证系统，风险和改动量都相对可控

2. **分阶段实施**：先实现认证对接，再逐步完善用户同步机制，最后优化性能

3. **充分测试**：特别是用户权限、数据关联等核心功能，需要在测试环境充分验证

4. **保留回滚方案**：在过渡期内保留原有认证方式，确保出现问题时可以快速回滚

5. **文档先行**：在开发前充分了解统一认证系统的技术规范和API接口，制定详细的技术方案

### 8.3 预估时间线

如果采用方案A（推荐），预计完整实施周期为 **4-6 周**（包括开发、测试、上线）：

- 第1-2周：核心认证和用户模型改造
- 第3-4周：用户同步机制和前端适配
- 第5-6周：测试、优化和上线准备

---

**文档版本：** v1.0  
**创建日期：** 2025-01-XX  
**最后更新：** 2025-01-XX

