# 创建和管理超级管理员

## 说明

在 Django 中，超级管理员需要满足：
1. **`is_staff=True`** - 允许访问 admin 后台
2. **`is_superuser=True`** - 拥有所有权限（包括修改所有数据）

**注意**：
- `role` 字段（使用方、管理方等）是**业务角色**，与 Django 的超级管理员权限是**两回事**
- `role='admin'` 不等于 `is_superuser=True`
- 500 错误通常不是权限问题（权限问题通常是 403 Forbidden）

## 方法 1：使用 Django Shell 修改现有用户（推荐）

在生产环境服务器上执行：

```bash
cd /opt/OMS/backend
source venv/bin/activate
python manage.py shell
```

在 Django shell 中执行：

```python
from apps.accounts.models import User

# 查找用户
user = User.objects.get(username='oms_admin')

# 设置为超级管理员
user.is_staff = True
user.is_superuser = True
user.save()

# 验证
print(f"用户: {user.username}")
print(f"is_staff: {user.is_staff}")
print(f"is_superuser: {user.is_superuser}")
print(f"role: {user.role}")

# 如果需要，也可以同时修改业务角色
user.role = 'admin'  # 可选：设置为管理方
user.save()
```

退出 shell：
```python
exit()
```

## 方法 2：使用 Django 管理命令创建新超级管理员

```bash
cd /opt/OMS/backend
source venv/bin/activate
python manage.py createsuperuser
```

按提示输入：
- 用户名
- 邮箱（可选）
- 密码（输入两次）

## 方法 3：一条命令快速修改（推荐用于脚本）

```bash
cd /opt/OMS/backend
source venv/bin/activate
python manage.py shell << 'EOF'
from apps.accounts.models import User
user = User.objects.get(username='oms_admin')
user.is_staff = True
user.is_superuser = True
user.save()
print(f"✅ {user.username} 已设置为超级管理员")
EOF
```

## 方法 4：创建管理脚本

创建文件 `backend/scripts/make_superuser.py`：

```python
#!/usr/bin/env python
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'oms_backend.settings')
django.setup()

from apps.accounts.models import User
import sys

username = sys.argv[1] if len(sys.argv) > 1 else 'oms_admin'

try:
    user = User.objects.get(username=username)
    user.is_staff = True
    user.is_superuser = True
    user.save()
    print(f"✅ {username} 已设置为超级管理员")
    print(f"   is_staff: {user.is_staff}")
    print(f"   is_superuser: {user.is_superuser}")
except User.DoesNotExist:
    print(f"❌ 用户 {username} 不存在")
except Exception as e:
    print(f"❌ 错误: {e}")
```

然后执行：

```bash
cd /opt/OMS/backend
source venv/bin/activate
python scripts/make_superuser.py oms_admin
```

## 验证超级管理员

### 方法 1：在 Django Shell 中验证

```bash
python manage.py shell
```

```python
from apps.accounts.models import User

user = User.objects.get(username='oms_admin')
print(f"用户名: {user.username}")
print(f"is_staff: {user.is_staff}")  # 应该是 True
print(f"is_superuser: {user.is_superuser}")  # 应该是 True
print(f"role: {user.role}")  # 业务角色
print(f"可以访问 admin: {user.is_staff}")  # 应该是 True
```

### 方法 2：在浏览器中验证

1. 访问：`http://172.29.91.61/admin/`
2. 使用 `oms_admin` 账号登录
3. 如果成功登录并看到管理后台，说明已经是超级管理员

## 关于 500 错误的说明

**500 错误通常不是权限问题**：
- **权限问题**通常返回 **403 Forbidden**（拒绝访问）
- **500 错误**是服务器内部错误，通常是因为代码错误或配置问题

但将用户设置为超级管理员是正确的做法，因为：
1. 确保有正确的权限访问所有功能
2. 可以在后台查看和管理所有数据
3. 避免因权限不足导致的某些问题

## 完整操作步骤（推荐）

在生产环境服务器上执行：

```bash
# 步骤 1：进入后端目录
cd /opt/OMS/backend
source venv/bin/activate

# 步骤 2：将 oms_admin 设置为超级管理员
python manage.py shell << 'EOF'
from apps.accounts.models import User
user = User.objects.get(username='oms_admin')
user.is_staff = True
user.is_superuser = True
# 可选：同时设置为管理方角色
user.role = 'admin'
user.save()
print(f"✅ {user.username} 已设置为超级管理员和管理方")
print(f"   is_staff: {user.is_staff}")
print(f"   is_superuser: {user.is_superuser}")
print(f"   role: {user.role}")
EOF

# 步骤 3：验证
echo ""
echo "验证用户权限："
python manage.py shell << 'EOF'
from apps.accounts.models import User
user = User.objects.get(username='oms_admin')
print(f"用户名: {user.username}")
print(f"is_staff: {user.is_staff}")
print(f"is_superuser: {user.is_superuser}")
print(f"role: {user.role}")
EOF
```

## 继续排查 500 错误

将用户设置为超级管理员后，500 错误可能仍然存在。请继续排查：

### 步骤 1：查看详细错误日志

```bash
# 临时启用 DEBUG 查看详细错误
cd /opt/OMS/backend
nano .env
# 将 DEBUG=False 改为 DEBUG=True

sudo systemctl restart oms-backend

# 访问 http://172.29.91.61/admin/accounts/user/
# 查看详细的错误页面
```

### 步骤 2：在 Django Shell 中测试

```bash
python manage.py shell
```

```python
from apps.accounts.models import User
from django.contrib import admin

# 测试查询
try:
    users = User.objects.all()
    print(f"用户总数: {users.count()}")
    
    # 测试每个用户的属性
    for user in users[:5]:
        try:
            print(f"✅ {user.username}: full_name={user.full_name}, created_at={user.created_at}")
        except Exception as e:
            print(f"❌ {user.username} 出错: {e}")
            import traceback
            traceback.print_exc()
except Exception as e:
    print(f"查询出错: {e}")
    import traceback
    traceback.print_exc()
```

### 步骤 3：简化 admin 配置测试

如果问题仍然存在，可以临时简化 `list_display`：

编辑 `backend/apps/accounts/admin.py`，将：

```python
list_display = ('username', 'get_full_name_display', 'email', 'role', 'phone', 'department', 'is_active', 'get_created_at_display')
```

临时改为：

```python
list_display = ('username', 'email', 'role', 'is_active')
```

然后重启服务测试。

## 总结

1. **将用户设置为超级管理员**：使用 Django shell 执行 `user.is_staff = True; user.is_superuser = True; user.save()`
2. **继续排查 500 错误**：查看详细错误日志，找出具体原因
3. **权限和 500 错误**：权限问题通常是 403，500 错误通常是代码或配置问题

