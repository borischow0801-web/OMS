# 生产环境问题排查与解决方案

## 问题汇总

1. 前端用超级管理员无法正常登录
2. 后端有报错：`[ERROR] Worker (pid:xxx) was sent SIGTERM!`
3. 后端 API 访问时出现 not found 页面
4. 管理员后台访问路径和批量增加人员

---

## 问题 1：前端用超级管理员无法正常登录

### 可能原因分析

1. **CORS 配置问题** - 前端请求被浏览器阻止
2. **API 路径错误** - 前端配置的 API 地址不正确
3. **后端 ALLOWED_HOSTS 配置** - 未包含服务器 IP
4. **登录 API 路径问题** - Nginx 代理配置错误

### 排查步骤

#### 步骤 1：检查后端日志

```bash
# 查看后端服务日志
sudo journalctl -u oms-backend.service -n 100 --no-pager

# 实时查看日志
sudo journalctl -u oms-backend.service -f
```

#### 步骤 2：检查前端 API 配置

查看前端 API 基础 URL 配置：

```bash
# 查看前端环境变量配置
cat /opt/OMS/frontend-pc/.env.local
# 或
cat /opt/OMS/frontend-pc/.env.production
```

确保配置了正确的 API 地址，例如：
```
VITE_API_BASE_URL=http://172.29.91.61/api
```

#### 步骤 3：检查后端 CORS 配置

编辑后端 `.env` 文件：

```bash
cd /opt/OMS/backend
nano .env
```

确保 `CORS_ALLOWED_ORIGINS` 包含前端地址：

```
CORS_ALLOWED_ORIGINS=http://172.29.91.61,http://localhost
```

然后重启后端服务：

```bash
sudo systemctl restart oms-backend
```

#### 步骤 4：检查 ALLOWED_HOSTS 配置

在 `.env` 文件中确保包含服务器 IP：

```
ALLOWED_HOSTS=172.29.91.61,localhost,127.0.0.1
```

#### 步骤 5：测试登录 API

在服务器上直接测试登录接口：

```bash
# 测试登录接口
curl -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"你的管理员用户名","password":"你的密码"}'

# 通过 Nginx 代理测试
curl -X POST http://localhost/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"你的管理员用户名","password":"你的密码"}'
```

#### 步骤 6：检查浏览器控制台

打开浏览器开发者工具（F12），查看：
- Console 标签页的错误信息
- Network 标签页的请求详情
  - 请求 URL 是否正确
  - 响应状态码是什么
  - 响应内容是什么

### 常见错误及解决方案

**错误 1：CORS 错误**
```
Access to XMLHttpRequest at 'http://172.29.91.61/api/auth/login/' 
from origin 'http://172.29.91.61' has been blocked by CORS policy
```

**解决**：在 `.env` 文件中添加：
```
CORS_ALLOWED_ORIGINS=http://172.29.91.61
```

**错误 2：401 Unauthorized**
- 检查用户名和密码是否正确
- 检查用户是否被禁用（`is_active=False`）

**错误 3：404 Not Found**
- 检查 API 路径是否正确（应该是 `/api/auth/login/`）
- 检查 Nginx 配置是否正确代理 `/api` 路径

---

## 问题 2：后端 Worker SIGTERM 错误

### 错误说明

```
[2025-12-07 15:35:17 +0800] [3321280] [ERROR] Worker (pid:3321281) was sent SIGTERM!
```

### 原因分析

这个错误通常**不是严重问题**，是 Gunicorn 的正常行为：

1. **服务重启** - 当你执行 `systemctl restart oms-backend` 时，Gunicorn 会向 worker 进程发送 SIGTERM 信号，让其优雅退出
2. **配置重载** - 某些配置更改会触发 worker 重启
3. **超时重启** - worker 进程运行时间过长会自动重启

### 检查是否正常

```bash
# 检查服务状态
sudo systemctl status oms-backend

# 如果显示 active (running)，说明服务正常
```

**如果服务状态正常，这个错误可以忽略。**

### 如果需要减少这个错误

可以调整 Gunicorn 配置，在 systemd 服务文件中增加超时时间：

编辑 `/etc/systemd/system/oms-backend.service`：

```ini
[Service]
# ... 其他配置 ...
ExecStart=/opt/OMS/backend/venv/bin/gunicorn \
    --workers 3 \
    --timeout 120 \  # 增加超时时间
    --graceful-timeout 30 \  # 优雅退出超时时间
    --bind 127.0.0.1:8000 \
    --access-logfile /var/log/oms/backend-access.log \
    --error-logfile /var/log/oms/backend-error.log \
    oms_backend.wsgi:application
```

然后重载并重启服务：

```bash
sudo systemctl daemon-reload
sudo systemctl restart oms-backend
```

---

## 问题 3：后端 API 访问时出现 not found 页面

### 可能原因

1. **Nginx 配置问题** - `/api` 路径没有正确代理
2. **后端服务未运行** - 后端服务未启动或崩溃
3. **URL 路径错误** - 访问的路径不存在

### 排查步骤

#### 步骤 1：检查后端服务状态

```bash
# 检查服务状态
sudo systemctl status oms-backend

# 查看服务日志
sudo journalctl -u oms-backend.service -n 50 --no-pager
```

#### 步骤 2：检查后端是否监听端口

```bash
# 检查 8000 端口是否被监听
netstat -tlnp | grep 8000
# 或
ss -tlnp | grep 8000

# 应该看到类似：
# tcp    0    0 127.0.0.1:8000    0.0.0.0:*    LISTEN    xxxx/python
```

#### 步骤 3：直接测试后端服务

**重要说明**：`/api/` 根路径返回 404 是**正常的**！后端没有定义这个路径，只有具体的子路径。

正确的测试方法（测试具体端点）：

```bash
# 测试登录接口（正确的端点）
curl -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

# 预期结果：
# - 返回 200 + token：后端正常，只是用户名/密码错误
# - 返回 400/401：后端正常，参数错误或认证失败
# - 返回 404：后端路径配置有问题
# - 连接被拒绝：后端服务未启动

# 测试管理员后台
curl http://127.0.0.1:8000/admin/

# 预期结果：应该返回 HTML 页面，不是 404
```

**说明**：
- `/api/` 返回 404 是正常的，因为没有定义这个路径
- 应该测试具体的端点，如 `/api/auth/login/`、`/admin/` 等
- 如果具体端点也返回 404，说明后端有问题
- 如果具体端点返回其他错误（如 401），说明后端正常，只是需要认证

如果具体端点测试能成功（即使返回 401），说明后端正常，问题在 Nginx 配置。

#### 步骤 4：检查 Nginx 配置

查看 Nginx 配置文件：

```bash
cat /etc/nginx/conf.d/oms.conf
```

确保有以下配置：

```nginx
# 后端API
location /api {
    proxy_pass http://oms_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 增加超时时间
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

#### 步骤 5：检查 upstream 配置

确保有 upstream 定义：

```nginx
upstream oms_backend {
    server 127.0.0.1:8000;
}
```

#### 步骤 6：测试 Nginx 配置并重载

```bash
# 测试配置
sudo nginx -t

# 如果测试通过，重载配置
sudo systemctl reload nginx

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

#### 步骤 7：通过 Nginx 测试 API

```bash
# 测试 API 根路径
curl http://localhost/api/

# 测试具体接口
curl http://localhost/api/auth/login/
```

### 常见错误及解决方案

**错误 1：502 Bad Gateway**

- **原因**：后端服务未运行或无法连接
- **解决**：
  ```bash
  # 检查并启动后端服务
  sudo systemctl start oms-backend
  sudo systemctl status oms-backend
  ```

**错误 2：404 Not Found**

- **原因 1**：Nginx 配置错误，`proxy_pass` 路径不正确
- **解决**：确保 `proxy_pass http://oms_backend;` 后面没有斜杠

- **原因 2**：后端 URL 路由配置问题
- **解决**：检查 `backend/oms_backend/urls.py` 配置

---

## 问题 4：管理员后台访问和批量增加人员

### 管理员后台访问地址

假设你的服务器 IP 是 `172.29.91.61`：

**管理员后台访问地址**：
```
http://172.29.91.61/admin/
```

### 配置 Nginx 支持管理员后台

需要在 Nginx 配置中添加 `/admin` 路径的代理。编辑 `/etc/nginx/conf.d/oms.conf`：

```nginx
# 后端API服务
upstream oms_backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name _;

    # 前端静态文件
    location / {
        root /opt/OMS/frontend-pc/dist;
        try_files $uri $uri/ /index.html;
    }

    # Django 管理后台（需要在 /api 之前）
    location /admin {
        proxy_pass http://oms_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端API
    location /api {
        proxy_pass http://oms_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加超时时间
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态文件缓存
    location /static {
        alias /opt/OMS/backend/staticfiles;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 媒体文件
    location /media {
        alias /opt/OMS/backend/media;
        expires 7d;
    }
}
```

**重要**：
- `/admin` 的 location 块必须在 `/api` **之前**，因为 Nginx 按顺序匹配
- 如果 `/api` 在前，`/admin` 会被匹配到 `/api` 规则

然后重载 Nginx：

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 访问管理员后台

1. **打开浏览器**，访问：`http://172.29.91.61/admin/`

2. **使用超级管理员账号登录**
   - 如果你还没有创建超级管理员，需要先创建：
   ```bash
   cd /opt/OMS/backend
   source venv/bin/activate
   python manage.py createsuperuser
   ```
   按提示输入用户名、邮箱和密码。

3. **登录后**，可以看到 Django 管理后台界面

### 批量增加人员

系统已经实现了批量导入用户功能，详细说明请参考：

**文档**：`docs/用户批量导入使用说明.md`

#### 快速使用步骤：

1. **生成导入模板**：
   ```bash
   cd /opt/OMS/backend
   source venv/bin/activate
   python manage.py generate_user_template
   ```
   模板文件会生成在 `docs/用户导入模板.xlsx`

2. **登录管理后台**：
   - 访问：`http://172.29.91.61/admin/`
   - 使用超级管理员账号登录

3. **进入用户管理页面**：
   - 点击左侧菜单的 **用户管理** → **用户**
   - 在页面顶部会看到 **"批量导入用户"** 按钮

4. **导入用户**：
   - 点击 **"批量导入用户"** 按钮
   - 上传填写好的 Excel 文件
   - 系统会自动验证并导入

#### 模板文件字段说明：

| 字段 | 说明 | 必填 |
|-----|------|-----|
| 用户名 | 唯一标识，用于登录 | 是 |
| 密码 | 至少 8 个字符 | 是 |
| 姓名 | 用户真实姓名 | 是 |
| 角色 | 使用方/管理方/项目经理/员工 | 是 |
| 邮箱 | 用户邮箱地址 | 否 |
| 手机号 | 用户手机号 | 否 |
| 部门 | 用户所在部门 | 否 |

---

## 完整排查清单

按以下顺序逐一排查：

- [ ] **后端服务状态**
  ```bash
  sudo systemctl status oms-backend
  ```

- [ ] **后端服务日志**
  ```bash
  sudo journalctl -u oms-backend.service -n 100
  ```

- [ ] **后端端口监听**
  ```bash
  netstat -tlnp | grep 8000
  ```

- [ ] **后端直接访问测试**
  ```bash
  curl http://127.0.0.1:8000/api/
  ```

- [ ] **Nginx 配置检查**
  ```bash
  sudo nginx -t
  cat /etc/nginx/conf.d/oms.conf
  ```

- [ ] **Nginx 错误日志**
  ```bash
  sudo tail -f /var/log/nginx/error.log
  ```

- [ ] **后端环境变量配置**
  ```bash
  cat /opt/OMS/backend/.env
  ```
  检查：
  - `ALLOWED_HOSTS` 是否包含服务器 IP
  - `CORS_ALLOWED_ORIGINS` 是否包含前端地址

- [ ] **前端 API 配置**
  ```bash
  cat /opt/OMS/frontend-pc/.env.local
  ```

- [ ] **浏览器控制台检查**
  - 打开浏览器开发者工具（F12）
  - 查看 Console 和 Network 标签页

---

## 推荐配置示例

### 后端 `.env` 文件（生产环境）

```
DEBUG=False
SECRET_KEY=你的密钥
ALLOWED_HOSTS=172.29.91.61,localhost,127.0.0.1
CORS_ALLOWED_ORIGINS=http://172.29.91.61
DATABASE_NAME=oms_db
DATABASE_USER=oms_user
DATABASE_PASSWORD=你的数据库密码
DATABASE_HOST=localhost
DATABASE_PORT=3306
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
```

### Nginx 完整配置示例

```nginx
upstream oms_backend {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name _;

    # Django 管理后台
    location /admin {
        proxy_pass http://oms_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端API
    location /api {
        proxy_pass http://oms_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 前端静态文件
    location / {
        root /opt/OMS/frontend-pc/dist;
        try_files $uri $uri/ /index.html;
    }

    # 静态文件
    location /static {
        alias /opt/OMS/backend/staticfiles;
        expires 30d;
    }

    # 媒体文件
    location /media {
        alias /opt/OMS/backend/media;
        expires 7d;
    }
}
```

---

## 快速修复命令

如果问题紧急，可以尝试以下命令：

```bash
# 1. 重启所有服务
sudo systemctl restart oms-backend
sudo systemctl restart nginx

# 2. 检查服务状态
sudo systemctl status oms-backend
sudo systemctl status nginx

# 3. 查看日志
sudo journalctl -u oms-backend.service -n 50
sudo tail -n 50 /var/log/nginx/error.log

# 4. 测试配置
sudo nginx -t

# 5. 测试 API
curl http://localhost/api/
curl http://localhost/admin/
```

---

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. 后端服务日志：`sudo journalctl -u oms-backend.service -n 200`
2. Nginx 错误日志：`sudo tail -n 100 /var/log/nginx/error.log`
3. 浏览器控制台错误信息（截图）
4. 网络请求详情（浏览器 Network 标签页）

