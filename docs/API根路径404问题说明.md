# API 根路径 404 问题说明

## 问题描述

在生产环境直接访问 `http://127.0.0.1:8000/api/` 时出现 404 Not Found 页面。

## 问题原因

**这是正常现象！** 后端 URL 配置中没有定义 `/api/` 根路径。

查看 `backend/oms_backend/urls.py`，只有以下路径：

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/auth/', include('apps.accounts.urls')),      # 登录等认证接口
    path('api/accounts/', include('apps.accounts.urls')),  # 用户管理接口
    path('api/tasks/', include('apps.tasks.urls')),        # 任务管理接口
    path('api/workflow/', include('apps.workflow.urls')),  # 工作流接口
]
```

没有 `/api/` 根路径的定义，所以访问 `/api/` 会返回 404。

## 正确的测试方法

应该测试具体的 API 端点，而不是根路径：

### 1. 测试登录接口（不需要认证）

```bash
curl -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"你的用户名","password":"你的密码"}'
```

**预期结果**：
- 成功：返回 200，包含 `access` 和 `refresh` token
- 失败：返回 401 或 400，包含错误信息

### 2. 测试用户接口（需要认证）

```bash
# 先获取 token
TOKEN=$(curl -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"你的用户名","password":"你的密码"}' | \
  grep -o '"access":"[^"]*' | cut -d'"' -f4)

# 使用 token 访问接口
curl http://127.0.0.1:8000/api/accounts/users/ \
  -H "Authorization: Bearer $TOKEN"
```

**预期结果**：
- 成功：返回 200，包含用户列表
- 未认证：返回 401 Unauthorized
- 路径错误：返回 404 Not Found

### 3. 测试任务接口（需要认证）

```bash
curl http://127.0.0.1:8000/api/tasks/tasks/ \
  -H "Authorization: Bearer $TOKEN"
```

### 4. 测试管理员后台

```bash
curl http://127.0.0.1:8000/admin/
```

**预期结果**：应该返回 Django 管理后台的 HTML 页面，而不是 404。

## 可用的 API 端点列表

### 认证相关（不需要认证）

- `POST /api/auth/login/` - 用户登录
- `POST /api/auth/refresh/` - 刷新 token

### 用户相关（需要认证）

- `GET /api/accounts/users/` - 获取用户列表
- `GET /api/accounts/users/{id}/` - 获取用户详情
- `GET /api/accounts/users/me/` - 获取当前用户信息
- `POST /api/accounts/users/` - 创建用户（仅管理员）
- `PUT /api/accounts/users/{id}/` - 更新用户（仅管理员）
- `DELETE /api/accounts/users/{id}/` - 删除用户（仅管理员）

### 任务相关（需要认证）

- `GET /api/tasks/tasks/` - 获取任务列表
- `GET /api/tasks/tasks/{id}/` - 获取任务详情
- `POST /api/tasks/tasks/` - 创建任务
- 等等...

### 工作流相关（需要认证）

- `GET /api/workflow/logs/` - 获取工作流日志
- `GET /api/workflow/notifications/` - 获取通知列表

## 如何判断后端是否正常

### 判断标准

1. **访问 `/api/auth/login/`**：
   - 返回 400 或 401（参数错误或认证失败）→ **后端正常**
   - 返回 404 → **后端有问题或路径错误**
   - 连接被拒绝 → **后端服务未启动**

2. **访问 `/admin/`**：
   - 返回 HTML 页面 → **后端正常**
   - 返回 404 → **后端有问题**

3. **访问 `/api/`**：
   - 返回 404 → **这是正常的**，因为路径未定义

### 排查步骤

```bash
# 步骤 1：检查后端服务状态
sudo systemctl status oms-backend

# 步骤 2：检查后端是否监听端口
netstat -tlnp | grep 8000

# 步骤 3：测试登录接口（最可靠的测试方法）
curl -v -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

# 步骤 4：查看后端日志
sudo journalctl -u oms-backend.service -n 50
```

## 可选：添加 API 根路径视图

如果你希望 `/api/` 返回一个 API 文档或可用端点列表，可以添加一个视图。

### 方法 1：创建简单的 API 根视图

创建文件 `backend/oms_backend/views.py`：

```python
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny
from rest_framework.response import Response

@api_view(['GET'])
@permission_classes([AllowAny])
def api_root(request):
    """API 根路径，返回可用端点列表"""
    return Response({
        'message': 'OMS API',
        'version': '1.0',
        'endpoints': {
            'auth': '/api/auth/',
            'accounts': '/api/accounts/',
            'tasks': '/api/tasks/',
            'workflow': '/api/workflow/',
            'admin': '/admin/',
        }
    })
```

然后在 `backend/oms_backend/urls.py` 中添加：

```python
from .views import api_root

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', api_root, name='api-root'),  # 添加这行
    path('api/auth/', include('apps.accounts.urls')),
    # ... 其他路径
]
```

### 方法 2：使用 Django REST Framework 的路由

如果你希望更完整的 API 文档，可以使用 DRF 的路由功能，但这需要更复杂的配置。

## 总结

- **`/api/` 返回 404 是正常的**，因为没有定义这个路径
- **应该测试具体的端点**，如 `/api/auth/login/`
- **如果具体端点也返回 404**，可能是路径配置问题或后端服务问题
- **如果具体端点返回 401 或其他错误（非 404）**，说明后端正常，只是需要认证或参数

## 快速诊断命令

```bash
# 诊断脚本
echo "=== 检查后端服务状态 ==="
sudo systemctl status oms-backend | head -5

echo -e "\n=== 检查端口监听 ==="
netstat -tlnp | grep 8000

echo -e "\n=== 测试登录接口 ==="
curl -s -o /dev/null -w "HTTP状态码: %{http_code}\n" \
  -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

echo -e "\n=== 测试管理员后台 ==="
curl -s -o /dev/null -w "HTTP状态码: %{http_code}\n" \
  http://127.0.0.1:8000/admin/

echo -e "\n=== 查看后端日志（最后10行） ==="
sudo journalctl -u oms-backend.service -n 10 --no-pager
```

运行这个脚本可以帮助快速诊断问题。

