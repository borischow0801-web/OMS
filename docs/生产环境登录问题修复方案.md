# 生产环境登录问题修复方案

## 问题分析

根据日志文件分析，登录失败的主要原因是：

1. **CORS跨域配置问题**：后端 `CORS_ALLOWED_ORIGINS` 只配置了本地开发地址，没有包含生产环境的公网地址 `http://59.224.25.175:2080`
2. **ALLOWED_HOSTS配置问题**：后端 `ALLOWED_HOSTS` 没有包含生产环境的公网IP `59.224.25.175` 和内网IP `172.29.91.61`
3. **前端API地址配置**：前端可能没有正确配置API基础地址

从日志第3行可以看到：
```
127.0.0.1 - - [16/Dec/2025:17:43:19 +0800] "POST /admin/login/?next=/admin/ HTTP/1.0" 403
```
返回403错误，这通常是CORS或ALLOWED_HOSTS配置导致的。

## 解决方案

### 第一步：修改后端环境变量配置

在服务器上编辑后端的 `.env` 文件（位于 `/home/zxy_8581/OMS/backend/.env`）：

```bash
cd /home/zxy_8581/OMS/backend
nano .env
```

修改以下配置项：

```env
# 生产环境配置
DEBUG=False

# ALLOWED_HOSTS - 必须包含内网IP和公网IP
ALLOWED_HOSTS=localhost,127.0.0.1,172.29.91.61,59.224.25.175

# CORS_ALLOWED_ORIGINS - 必须包含前端访问地址
CORS_ALLOWED_ORIGINS=http://59.224.25.175:2080,http://172.29.91.61:80

# 其他配置保持不变
SECRET_KEY=your-secret-key-here
DATABASE_NAME=oms_db
DATABASE_USER=oms_user
DATABASE_PASSWORD=your_secure_password
DATABASE_HOST=localhost
DATABASE_PORT=3306
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
JWT_ACCESS_TOKEN_LIFETIME=60
JWT_REFRESH_TOKEN_LIFETIME=1440
```

**重要提示**：
- `ALLOWED_HOSTS` 中的IP地址之间用逗号分隔，**不要有空格**
- `CORS_ALLOWED_ORIGINS` 中的URL必须包含协议（http://或https://）和端口号
- 如果前端使用HTTPS，需要将 `http://` 改为 `https://`

### 第二步：重启后端服务

修改配置后，需要重启Gunicorn服务使配置生效：

```bash
# 如果使用systemd管理服务
sudo systemctl restart gunicorn

# 或者如果使用supervisor
sudo supervisorctl restart oms_backend

# 或者如果直接运行gunicorn，需要先停止再启动
# 查找gunicorn进程
ps aux | grep gunicorn
# 停止进程（使用进程ID）
kill -HUP <进程ID>
# 然后重新启动
cd /home/zxy_8581/OMS/backend
source venv/bin/activate
gunicorn oms_backend.wsgi:application --bind 127.0.0.1:8000 --workers 3
```

### 第三步：检查前端API配置

检查前端构建后的配置文件，确保API地址正确。

如果前端使用环境变量，需要在构建时设置：

```bash
cd /home/zxy_8581/OMS/frontend-pc

# 创建或编辑 .env.production 文件
cat > .env.production << EOF
VITE_API_BASE_URL=http://59.224.25.175:2080/api
EOF

# 重新构建前端
npm run build
```

如果前端已经部署，检查 `dist` 目录中的配置文件，或者检查Nginx配置中的代理设置。

### 第四步：验证配置

1. **检查后端配置是否生效**：
```bash
cd /home/zxy_8581/OMS/backend
source venv/bin/activate
python manage.py shell
```

在Python shell中执行：
```python
from django.conf import settings
print("ALLOWED_HOSTS:", settings.ALLOWED_HOSTS)
print("CORS_ALLOWED_ORIGINS:", settings.CORS_ALLOWED_ORIGINS)
```

确认输出包含生产环境的IP和URL。

2. **测试API接口**：
```bash
# 测试登录接口
curl -X POST http://59.224.25.175:2080/api/auth/login/ \
  -H "Content-Type: application/json" \
  -H "Origin: http://59.224.25.175:2080" \
  -d '{"username":"test","password":"test"}'
```

如果返回CORS错误，说明CORS配置还有问题。

3. **检查浏览器控制台**：
   - 打开浏览器开发者工具（F12）
   - 查看Network标签页，找到登录请求
   - 查看Response Headers中是否有 `Access-Control-Allow-Origin` 头
   - 查看Console标签页是否有CORS相关错误

## 常见问题排查

### 问题1：仍然返回403错误

**可能原因**：
- `.env` 文件修改后没有重启服务
- `.env` 文件格式错误（有多余空格、换行等）
- 环境变量没有正确加载

**解决方法**：
1. 确认 `.env` 文件格式正确（每行一个配置，等号两边不要有空格）
2. 重启服务
3. 检查服务日志确认配置已加载

### 问题2：CORS错误（跨域问题）

**错误信息**：
```
Access to XMLHttpRequest at 'http://59.224.25.175:2080/api/auth/login/' from origin 'http://59.224.25.175:2080' has been blocked by CORS policy
```

**解决方法**：
1. 确认 `CORS_ALLOWED_ORIGINS` 配置正确，包含完整URL（协议+域名+端口）
2. 确认前端请求的Origin与配置的URL完全匹配（包括协议和端口）
3. 如果使用Nginx反向代理，检查Nginx配置是否正确转发Origin头

### 问题3：前端请求地址不正确

**解决方法**：
1. 检查前端构建时的环境变量配置
2. 如果使用相对路径 `/api`，确保前端和后端在同一域名下
3. 如果使用绝对路径，确保地址正确且可访问

### 问题4：Nginx配置问题

如果使用Nginx作为反向代理，需要确保Nginx配置正确：

```nginx
server {
    listen 80;
    server_name 172.29.91.61;

    # 前端静态文件
    location / {
        root /home/zxy_8581/OMS/frontend-pc/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS相关头
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        
        # 处理OPTIONS预检请求
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
}
```

修改Nginx配置后需要重启：
```bash
sudo nginx -t  # 测试配置
sudo systemctl reload nginx  # 重新加载配置
```

## 快速修复脚本

在服务器上执行以下命令快速修复配置：

```bash
#!/bin/bash
# 快速修复生产环境登录问题

BACKEND_DIR="/home/zxy_8581/OMS/backend"
ENV_FILE="$BACKEND_DIR/.env"

# 备份现有配置
if [ -f "$ENV_FILE" ]; then
    cp "$ENV_FILE" "$ENV_FILE.backup.$(date +%Y%m%d_%H%M%S)"
fi

# 检查并更新ALLOWED_HOSTS
if grep -q "ALLOWED_HOSTS" "$ENV_FILE" 2>/dev/null; then
    # 如果存在，更新它
    sed -i 's|^ALLOWED_HOSTS=.*|ALLOWED_HOSTS=localhost,127.0.0.1,172.29.91.61,59.224.25.175|' "$ENV_FILE"
else
    # 如果不存在，添加它
    echo "ALLOWED_HOSTS=localhost,127.0.0.1,172.29.91.61,59.224.25.175" >> "$ENV_FILE"
fi

# 检查并更新CORS_ALLOWED_ORIGINS
if grep -q "CORS_ALLOWED_ORIGINS" "$ENV_FILE" 2>/dev/null; then
    # 如果存在，更新它
    sed -i 's|^CORS_ALLOWED_ORIGINS=.*|CORS_ALLOWED_ORIGINS=http://59.224.25.175:2080,http://172.29.91.61:80|' "$ENV_FILE"
else
    # 如果不存在，添加它
    echo "CORS_ALLOWED_ORIGINS=http://59.224.25.175:2080,http://172.29.91.61:80" >> "$ENV_FILE"
fi

# 确保DEBUG=False（生产环境）
sed -i 's|^DEBUG=.*|DEBUG=False|' "$ENV_FILE"

echo "配置已更新，请重启后端服务！"
echo "执行: sudo systemctl restart gunicorn 或 supervisorctl restart oms_backend"
```

**使用方法**：
1. 将上述脚本保存为 `fix_login.sh`
2. 赋予执行权限：`chmod +x fix_login.sh`
3. 执行脚本：`./fix_login.sh`
4. 重启后端服务

## 验证清单

完成以上步骤后，请确认：

- [ ] `.env` 文件中 `ALLOWED_HOSTS` 包含 `59.224.25.175` 和 `172.29.91.61`
- [ ] `.env` 文件中 `CORS_ALLOWED_ORIGINS` 包含 `http://59.224.25.175:2080`
- [ ] `.env` 文件中 `DEBUG=False`（生产环境）
- [ ] 后端服务已重启
- [ ] 前端API地址配置正确
- [ ] Nginx配置正确（如果使用）
- [ ] 浏览器控制台没有CORS错误
- [ ] 登录请求返回200或401（不是403）

## 测试步骤

1. **清除浏览器缓存和Cookie**：
   - 按 `Ctrl+Shift+Delete` 清除缓存
   - 或者使用无痕模式测试

2. **打开浏览器开发者工具**（F12）：
   - 切换到 Network 标签页
   - 勾选 "Preserve log"
   - 尝试登录

3. **检查请求和响应**：
   - 找到 `/api/auth/login/` 请求
   - 查看 Request Headers 中的 `Origin`
   - 查看 Response Headers 中是否有 `Access-Control-Allow-Origin`
   - 查看 Status Code（应该是200或401，不应该是403）

4. **如果仍然失败，查看详细错误**：
   - Console 标签页中的错误信息
   - Network 标签页中请求的 Response 内容

## 联系支持

如果按照以上步骤操作后仍然无法登录，请提供：
1. 后端 `.env` 文件内容（隐藏敏感信息）
2. Nginx配置文件（如果使用）
3. 浏览器控制台的完整错误信息
4. 后端服务日志的最新错误信息

