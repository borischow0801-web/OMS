# 前端登录问题排查与解决

## 问题分析

后端登录接口测试成功，返回了 token 和用户信息，说明后端工作正常。前端无法登录，问题可能在前端配置或 CORS 设置。

## 可能的原因

### 1. 前端 API 配置问题（最可能）

前端代码中 API 基础 URL 配置：
```javascript
baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000/api'
```

**问题**：
- 如果构建时没有设置 `VITE_API_BASE_URL` 环境变量
- 前端会使用默认值 `http://localhost:8000/api`
- 浏览器中访问 `http://172.29.91.61` 时，会尝试请求 `http://localhost:8000/api`，导致失败

**解决方案**：

#### 方案 A：使用相对路径（推荐）

修改前端 API 配置，使用相对路径：

修改 `frontend-pc/src/api/index.js`：
```javascript
const api = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',  // 改为相对路径
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
})
```

然后重新构建前端：
```bash
cd /opt/OMS/frontend-pc
npm run build
```

#### 方案 B：构建时设置环境变量

在构建前端时设置环境变量：

```bash
cd /opt/OMS/frontend-pc

# 创建生产环境变量文件
cat > .env.production << EOF
VITE_API_BASE_URL=http://172.29.91.61/api
EOF

# 重新构建
npm run build
```

### 2. CORS 配置问题

后端可能没有正确配置 CORS，导致浏览器阻止跨域请求。

**检查步骤**：

```bash
cd /opt/OMS/backend
cat .env | grep CORS
```

确保包含：
```
CORS_ALLOWED_ORIGINS=http://172.29.91.61
```

如果没有，添加后重启：
```bash
# 编辑 .env 文件
nano .env

# 添加或修改
CORS_ALLOWED_ORIGINS=http://172.29.91.61

# 重启服务
sudo systemctl restart oms-backend
```

### 3. 浏览器控制台错误

打开浏览器开发者工具（F12），查看具体的错误信息。

## 完整排查步骤

### 步骤 1：检查浏览器控制台

1. 打开浏览器，访问 `http://172.29.91.61`
2. 按 F12 打开开发者工具
3. 点击 **Network** 标签页
4. 尝试登录
5. 查看登录请求：
   - 请求 URL 是什么？（应该是 `/api/auth/login/` 或 `http://172.29.91.61/api/auth/login/`）
   - 请求状态码是什么？（200、404、500、CORS 错误？）
   - 响应内容是什么？

6. 查看 **Console** 标签页：
   - 是否有 JavaScript 错误？
   - 是否有 CORS 错误信息？

### 步骤 2：检查前端构建配置

```bash
# 查看前端构建后的文件
ls -la /opt/OMS/frontend-pc/dist/

# 检查是否有环境变量文件
ls -la /opt/OMS/frontend-pc/.env*

# 查看构建配置
cat /opt/OMS/frontend-pc/vite.config.js
```

### 步骤 3：测试 API 请求

在浏览器控制台（Console）中执行：

```javascript
// 测试 API 请求
fetch('/api/auth/login/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    username: 'oms_admin',
    password: 'Oms_@159Zxy'
  })
})
.then(res => res.json())
.then(data => console.log('成功:', data))
.catch(err => console.error('错误:', err))
```

### 步骤 4：检查后端 CORS 配置

```bash
cd /opt/OMS/backend

# 查看 CORS 配置
cat .env | grep CORS

# 如果缺少，添加配置
nano .env

# 添加：
# CORS_ALLOWED_ORIGINS=http://172.29.91.61

# 重启服务
sudo systemctl restart oms-backend
```

### 步骤 5：检查 Nginx 配置

确保 Nginx 正确代理 `/api` 路径：

```bash
cat /etc/nginx/conf.d/oms.conf | grep -A 10 "location /api"
```

应该看到：
```nginx
location /api {
    proxy_pass http://oms_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## 推荐解决方案

### 方案 1：修改前端使用相对路径（最简单）

1. **修改前端代码**：

编辑 `frontend-pc/src/api/index.js`，将：
```javascript
baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000/api',
```

改为：
```javascript
baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
```

2. **重新构建前端**：

```bash
cd /opt/OMS/frontend-pc
npm run build
```

3. **验证**：访问 `http://172.29.91.61` 并尝试登录

### 方案 2：配置环境变量后重新构建

1. **创建生产环境变量文件**：

```bash
cd /opt/OMS/frontend-pc
cat > .env.production << EOF
VITE_API_BASE_URL=http://172.29.91.61/api
EOF
```

2. **重新构建**：

```bash
npm run build
```

3. **验证**：访问 `http://172.29.91.61` 并尝试登录

### 方案 3：确保 CORS 配置正确

1. **检查并更新后端 CORS 配置**：

```bash
cd /opt/OMS/backend
nano .env
```

确保包含：
```
CORS_ALLOWED_ORIGINS=http://172.29.91.61
```

2. **重启后端服务**：

```bash
sudo systemctl restart oms-backend
```

## 快速诊断命令

在服务器上执行：

```bash
#!/bin/bash

echo "=== 前端登录问题诊断 ==="
echo ""

echo "1. 检查前端构建目录："
ls -la /opt/OMS/frontend-pc/dist/ | head -5
echo ""

echo "2. 检查后端 CORS 配置："
cd /opt/OMS/backend
cat .env | grep CORS || echo "⚠️  未找到 CORS 配置"
echo ""

echo "3. 测试后端登录接口（通过 Nginx）："
curl -s -o /dev/null -w "HTTP状态码: %{http_code}\n" \
  -X POST http://localhost/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'
echo ""

echo "4. 检查 Nginx API 代理配置："
grep -A 5 "location /api" /etc/nginx/conf.d/oms.conf 2>/dev/null || echo "⚠️  未找到 API 代理配置"
echo ""

echo "=== 诊断完成 ==="
echo ""
echo "下一步："
echo "1. 打开浏览器开发者工具（F12）"
echo "2. 查看 Network 标签页中的登录请求"
echo "3. 查看 Console 标签页中的错误信息"
echo "4. 根据错误信息进行相应修复"
```

## 注意事项

1. **前端构建时的环境变量**：
   - Vite 在构建时会读取环境变量
   - 环境变量必须以 `VITE_` 开头
   - 构建后，环境变量会被编译进代码

2. **使用相对路径的优势**：
   - 不需要修改环境变量
   - 适用于任何域名/IP
   - 通过 Nginx 代理，路径自动正确

3. **CORS 配置**：
   - 必须包含前端访问的完整 URL（包含协议和端口）
   - 如果有端口，必须包含端口号
   - 多个地址用逗号分隔

## 验证修复

修复后，按以下步骤验证：

1. **清除浏览器缓存**：
   - 按 `Ctrl+Shift+Delete` 清除缓存
   - 或使用无痕模式访问

2. **打开浏览器开发者工具**：
   - 按 F12
   - 打开 Network 和 Console 标签页

3. **尝试登录**：
   - 输入用户名和密码
   - 点击登录

4. **检查请求**：
   - Network 标签页中查看登录请求
   - 应该看到请求 URL 是 `/api/auth/login/` 或 `http://172.29.91.61/api/auth/login/`
   - 状态码应该是 200
   - 响应应该包含 token

5. **检查是否有错误**：
   - Console 标签页不应该有错误
   - Network 标签页不应该有红色错误请求

## 总结

**最可能的原因**：
1. 前端 API 配置使用了 `localhost:8000`，应该使用相对路径 `/api`
2. CORS 配置缺少前端地址

**推荐解决方案**：
1. 修改前端代码使用相对路径 `/api`
2. 重新构建前端
3. 确保后端 CORS 配置包含前端地址

