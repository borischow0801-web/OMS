# 验证 .env 文件配置是否生效

## 方法1：使用 Django Shell 检查（推荐）

这是最直接的方法，可以查看 Django 实际加载的配置值。

### 步骤1：进入 Django Shell
```bash
cd /opt/OMS/backend  # 或 /home/zxy_8581/OMS/backend（根据实际路径）
source venv/bin/activate
python manage.py shell
```

### 步骤2：检查配置值
在 Python shell 中执行以下命令：

```python
# 导入 Django 配置
from django.conf import settings

# 检查 ALLOWED_HOSTS
print("ALLOWED_HOSTS:", settings.ALLOWED_HOSTS)
print("是否包含 59.224.25.175:", '59.224.25.175' in settings.ALLOWED_HOSTS)
print("是否包含 172.29.91.61:", '172.29.91.61' in settings.ALLOWED_HOSTS)

# 检查 CORS 配置
print("\nCORS_ALLOWED_ORIGINS:", settings.CORS_ALLOWED_ORIGINS)
print("是否包含 http://59.224.25.175:2080:", 'http://59.224.25.175:2080' in settings.CORS_ALLOWED_ORIGINS)

# 检查 DEBUG 模式
print("\nDEBUG:", settings.DEBUG)

# 检查数据库配置（不显示密码）
print("\n数据库配置:")
print("  DATABASE_NAME:", settings.DATABASES['default']['NAME'])
print("  DATABASE_HOST:", settings.DATABASES['default']['HOST'])
print("  DATABASE_PORT:", settings.DATABASES['default']['PORT'])

# 退出 shell
exit()
```

### 预期输出示例
```
ALLOWED_HOSTS: ['localhost', '127.0.0.1', '172.29.91.61', '59.224.25.175']
是否包含 59.224.25.175: True
是否包含 172.29.91.61: True

CORS_ALLOWED_ORIGINS: ['http://59.224.25.175:2080', 'http://172.29.91.61:80']
是否包含 http://59.224.25.175:2080: True

DEBUG: False

数据库配置:
  DATABASE_NAME: oms_db
  DATABASE_HOST: localhost
  DATABASE_PORT: 3306
```

✅ **如果输出正确**：说明配置已生效  
❌ **如果输出不正确**：
- 检查 `.env` 文件格式是否正确
- 确认服务已重启
- 检查 `.env` 文件路径是否正确

## 方法2：使用命令行脚本快速检查

创建一个快速检查脚本：

```bash
#!/bin/bash
# 快速检查 .env 配置是否生效

cd /opt/OMS/backend  # 或 /home/zxy_8581/OMS/backend
source venv/bin/activate

python manage.py shell << EOF
from django.conf import settings

print("=" * 50)
print("配置检查结果")
print("=" * 50)

# 检查 ALLOWED_HOSTS
print("\n1. ALLOWED_HOSTS:")
print(f"   值: {settings.ALLOWED_HOSTS}")
print(f"   包含 59.224.25.175: {'59.224.25.175' in settings.ALLOWED_HOSTS}")
print(f"   包含 172.29.91.61: {'172.29.91.61' in settings.ALLOWED_HOSTS}")

# 检查 CORS
print("\n2. CORS_ALLOWED_ORIGINS:")
print(f"   值: {settings.CORS_ALLOWED_ORIGINS}")
print(f"   包含 http://59.224.25.175:2080: {'http://59.224.25.175:2080' in settings.CORS_ALLOWED_ORIGINS}")

# 检查 DEBUG
print("\n3. DEBUG 模式:")
print(f"   值: {settings.DEBUG}")
print(f"   状态: {'生产环境' if not settings.DEBUG else '开发环境（警告！）'}")

print("\n" + "=" * 50)
EOF
```

保存为 `check_env.sh`，然后执行：
```bash
chmod +x check_env.sh
./check_env.sh
```

## 方法3：通过 API 请求测试

### 测试1：检查 CORS 头
```bash
# 测试 OPTIONS 预检请求
curl -X OPTIONS http://59.224.25.175:2080/api/auth/login/ \
  -H "Origin: http://59.224.25.175:2080" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization" \
  -v
```

**预期结果**：
- 应该返回 `204 No Content`
- Response Headers 中应该包含 `Access-Control-Allow-Origin: http://59.224.25.175:2080`

### 测试2：检查 ALLOWED_HOSTS
```bash
# 使用公网IP访问
curl -X GET http://59.224.25.175:2080/api/auth/login/ \
  -H "Host: 59.224.25.175:2080" \
  -v
```

**预期结果**：
- 如果 ALLOWED_HOSTS 配置正确：返回 405 Method Not Allowed（因为 GET 方法不允许，但说明请求到达了后端）
- 如果 ALLOWED_HOSTS 配置错误：返回 400 Bad Request 或 Django 的 "DisallowedHost" 错误

### 测试3：实际登录请求
```bash
# 测试登录接口（使用错误的凭据，只测试配置）
curl -X POST http://59.224.25.175:2080/api/auth/login/ \
  -H "Content-Type: application/json" \
  -H "Origin: http://59.224.25.175:2080" \
  -d '{"username":"test","password":"wrong"}' \
  -v
```

**预期结果**：
- 如果配置正确：返回 401 Unauthorized（认证失败，但说明请求成功到达后端）
- 如果配置错误：返回 403 Forbidden 或 CORS 错误

## 方法4：检查服务日志

### 查看 Gunicorn 日志
```bash
# 如果使用 systemd
sudo journalctl -u gunicorn -n 50 --no-pager

# 如果使用 supervisor
sudo supervisorctl tail -f oms_backend

# 如果直接运行，查看日志文件
tail -f /opt/OMS/backend/logs/*.log
```

### 查看 Nginx 日志
```bash
# 访问日志
sudo tail -f /var/log/nginx/access.log

# 错误日志
sudo tail -f /var/log/nginx/error.log
```

**查找关键信息**：
- 如果看到 `DisallowedHost` 错误：说明 ALLOWED_HOSTS 配置不正确
- 如果看到 CORS 相关错误：说明 CORS 配置不正确

## 方法5：浏览器开发者工具检查

1. **打开浏览器开发者工具**（F12）
2. **切换到 Network 标签页**
3. **尝试登录**
4. **查看请求详情**：

   **检查请求头**：
   - Request Headers 中应该有 `Origin: http://59.224.25.175:2080`
   
   **检查响应头**：
   - Response Headers 中应该有 `Access-Control-Allow-Origin: http://59.224.25.175:2080`
   - 如果没有这个头，说明 CORS 配置未生效

   **检查状态码**：
   - 200 或 401：配置正确（401 是认证失败，但说明请求成功）
   - 403：可能是 CORS 或 ALLOWED_HOSTS 问题
   - 400：可能是 ALLOWED_HOSTS 问题

## 常见问题排查

### 问题1：配置显示不正确

**可能原因**：
1. `.env` 文件格式错误
2. 服务未重启
3. `.env` 文件路径不正确

**解决方法**：
```bash
# 检查 .env 文件格式
cat /opt/OMS/backend/.env | grep -E "ALLOWED_HOSTS|CORS_ALLOWED_ORIGINS"

# 确认格式正确（等号两边不要有空格，多个值用逗号分隔）
# 正确格式：
# ALLOWED_HOSTS=localhost,127.0.0.1,172.29.91.61,59.224.25.175
# 错误格式：
# ALLOWED_HOSTS = localhost, 127.0.0.1  # 有空格
```

### 问题2：服务重启后配置仍未生效

**解决方法**：
```bash
# 1. 确认服务完全重启
sudo systemctl stop gunicorn
sudo systemctl start gunicorn

# 或
sudo supervisorctl restart oms_backend

# 2. 检查服务状态
sudo systemctl status gunicorn

# 3. 查看服务启动日志，确认没有错误
sudo journalctl -u gunicorn -n 100
```

### 问题3：环境变量未加载

**检查 python-decouple 是否正确安装**：
```bash
cd /opt/OMS/backend
source venv/bin/activate
python -c "from decouple import config; print(config('ALLOWED_HOSTS', default='not found'))"
```

如果返回 `not found`，说明 `.env` 文件未被找到或路径不正确。

## 完整验证清单

使用以下清单确保配置完全生效：

- [ ] `.env` 文件格式正确（无多余空格，正确分隔符）
- [ ] `.env` 文件路径正确（`/opt/OMS/backend/.env` 或 `/home/zxy_8581/OMS/backend/.env`）
- [ ] Django Shell 中 `ALLOWED_HOSTS` 包含 `59.224.25.175` 和 `172.29.91.61`
- [ ] Django Shell 中 `CORS_ALLOWED_ORIGINS` 包含 `http://59.224.25.175:2080`
- [ ] Django Shell 中 `DEBUG=False`（生产环境）
- [ ] 后端服务已完全重启
- [ ] curl 测试 OPTIONS 请求返回 204 和正确的 CORS 头
- [ ] curl 测试 POST 请求返回 401（不是 403）
- [ ] 浏览器开发者工具中看到正确的 CORS 响应头
- [ ] 浏览器控制台没有 CORS 错误

## 快速验证命令（一键检查）

将以下内容保存为 `verify_env.sh`：

```bash
#!/bin/bash
# 一键验证 .env 配置

BACKEND_DIR="/opt/OMS/backend"  # 根据实际路径修改
# BACKEND_DIR="/home/zxy_8581/OMS/backend"  # 或使用这个路径

cd "$BACKEND_DIR"
source venv/bin/activate

echo "=========================================="
echo "验证 .env 配置是否生效"
echo "=========================================="
echo ""

python manage.py shell << 'PYTHON_EOF'
from django.conf import settings

print("1. ALLOWED_HOSTS 检查:")
allowed_hosts = settings.ALLOWED_HOSTS
print(f"   当前值: {allowed_hosts}")
print(f"   ✓ 包含 59.224.25.175: {'✓' if '59.224.25.175' in allowed_hosts else '✗'}")
print(f"   ✓ 包含 172.29.91.61: {'✓' if '172.29.91.61' in allowed_hosts else '✗'}")

print("\n2. CORS_ALLOWED_ORIGINS 检查:")
cors_origins = settings.CORS_ALLOWED_ORIGINS
print(f"   当前值: {cors_origins}")
print(f"   ✓ 包含 http://59.224.25.175:2080: {'✓' if 'http://59.224.25.175:2080' in cors_origins else '✗'}")

print("\n3. DEBUG 模式检查:")
debug_mode = settings.DEBUG
print(f"   当前值: {debug_mode}")
print(f"   状态: {'✓ 生产环境' if not debug_mode else '✗ 开发环境（警告！生产环境应设为False）'}")

print("\n==========================================")
print("验证完成")
print("==========================================")
PYTHON_EOF
```

使用方法：
```bash
chmod +x verify_env.sh
./verify_env.sh
```

