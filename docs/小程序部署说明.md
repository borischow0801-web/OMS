# 微信小程序端部署说明（麒麟 V10 内网环境）

适用场景：生产服务器为麒麟 V10，处于内网不可直连互联网，仅可开放**指定端口**对外访问。目标是让微信小程序通过该端口访问后端 API。

## 1. 前置条件
- 服务器：麒麟 V10，已部署后端服务（Gunicorn + Nginx）并可在内网访问。
- 代码路径：`/home/zxy_8581/OMS/frontend-miniprogram`
- 已准备微信小程序 AppID（生产环境须使用正式 AppID，且配置合法域名）。
- 具备可对外开放的端口（推荐 443，如不能开放 443，则在出口网关/防火墙做端口映射，将外部固定端口转发到服务器的 443/80）。
- 若需 HTTPS，已准备证书文件，或使用内网 CA 证书并在设备上预装。

## 2. 网络与域名规划
1) **推荐方式**：使用域名 + 443 端口  
   - 在网关/防火墙开放 443，对外域名解析到公网/出口 IP，再由网关转发到服务器内网 IP 的 443/80。  
   - 在服务器上为 Nginx 配置该域名的 HTTPS（或 HTTP，如果企业内部允许小程序使用 http 测试域名，但生产建议 https）。

2) **仅能开放自定义端口的情况**  
   - 小程序“合法域名”不支持自定义端口的 http，建议在网关侧做**端口映射**：外部 443 → 内网服务器 8443（或 80），保证小程序看到的仍是 443。  
   - 如果必须使用非 443 端口，请确认微信小程序后台是否允许（通常仅 https/443 合法）；如不允许，需要调整网络策略使用 443。

## 3. Nginx 示例（小程序专用入口）
假设：  
- 内网后端监听：`127.0.0.1:8000`  
- 外部开放端口：443（网关映射到服务器 443）  
- 域名：`mini.example.com`（示例，替换为实际域名或出口 IP 对应域名）

```nginx
upstream oms_backend {
    server 127.0.0.1:8000;
}

server {
    listen 443 ssl;
    server_name mini.example.com;

    # 证书路径替换为实际文件
    ssl_certificate /etc/nginx/ssl/mini.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/mini.example.com.key;

    # 仅开放 API（如需静态/媒体请按需增加）
    location /api {
        proxy_pass http://oms_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

> 如果只能开放 80，可将 `listen 443 ssl` 改为 `listen 80;` 并去掉证书配置，但微信小程序生产环境要求 https，尽量保持 443/https。

## 4. 微信小程序合法域名配置
1) 登录微信公众平台 → 开发 → 开发管理 → 开发设置 → **服务器域名**。  
2) 将以下域名加入“request 合法域名”：  
   - `https://mini.example.com`（替换为实际域名；若使用端口映射，依然填 443 域名）。  
3) 如果使用内网 CA 证书，需要在小程序客户端设备上预装该 CA，确保 HTTPS 不被拦截。

## 5. 项目配置与构建
1) 代码路径：`/home/zxy_8581/OMS/frontend-miniprogram`。  
2) 配置 API 地址：编辑 `utils/config.js`（或项目内 API 配置文件），将基础地址设为小程序可访问的域名：
   ```javascript
   // 示例，替换为实际域名
   const baseUrl = 'https://mini.example.com/api';
   export default {
     baseUrl,
   };
   ```
   - 如果还需区分环境，可增加条件分支，但生产版请写死为正式域名。

3) 使用微信开发者工具导入项目  
   - 打开微信开发者工具 → 选择“导入项目” → 目录选择 `/home/zxy_8581/OMS/frontend-miniprogram`。  
   - 填写 AppID（生产使用正式 AppID）。  
   - 项目设置中关闭“ES6 转 ES5”仅在需要时调整，按团队规范执行。

4) 真机调试/预览  
   - 确保手机可访问 `https://mini.example.com/api`（通过开放端口/网关映射）。  
   - 如遇证书不受信问题，检查证书链或在设备预装 CA。

5) 提交审核与发布  
   - 按标准流程在微信开发者工具上传代码包。  
   - 审核前再次确认“服务器域名”已生效，HTTPS 正常，接口可通。

## 6. 验证与排查
- 在微信开发者工具“网络”面板查看请求是否成功到达 `mini.example.com/api`。  
- 服务器侧查看 Nginx 访问日志/后端日志，确认请求命中。  
- 若 502/超时，检查网关端口映射、防火墙和 Nginx upstream 配置。  
- 若证书报错，检查证书链或改用受信 CA。

## 7. 小程序已实现的主要功能
- 登录 / 退出登录。  
- 任务列表与任务详情查看。  
- 任务提交、审核、分配、处理、完成、退回等流程操作（与角色权限关联）。  
- 评论/备注与附件上传查看。  
- 通知/消息查看（与后台通知/短信策略配合）。  
- 个人信息查看与基础资料维护（如手机号用于短信通知）。  
- 基于角色的可见性与操作限制（使用方/管理方/项目经理/执行人）。

