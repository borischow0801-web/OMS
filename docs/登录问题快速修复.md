# 登录问题快速修复指南

## 问题症状
- 前端可以打开登录页面
- 输入账号密码后点击登录，提示"登录失败"
- 浏览器控制台可能显示CORS错误或403错误

## 根本原因
1. **后端配置问题**：生产环境的公网地址 `59.224.25.175:2080` 没有配置到后端的CORS和ALLOWED_HOSTS中
2. **Nginx配置问题**：缺少OPTIONS预检请求处理和CORS头配置

## 快速修复（4步）

### 步骤1：修复Nginx配置（重要！）
编辑 `/etc/nginx/conf.d/oms.conf` 文件：

```bash
sudo nano /etc/nginx/conf.d/oms.conf
```

找到 `location /api` 部分，修改为：

```nginx
location /api {
    # 处理OPTIONS预检请求
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Max-Age' 1728000 always;
        add_header 'Content-Length' 0 always;
        return 204;
    }

    proxy_pass http://oms_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Origin $http_origin;
    
    # 增加超时时间
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

然后测试并重新加载：
```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 步骤2：修改后端配置
编辑 `/home/zxy_8581/OMS/backend/.env` 文件：

```bash
cd /home/zxy_8581/OMS/backend
nano .env
```

修改这两行：
```env
ALLOWED_HOSTS=localhost,127.0.0.1,172.29.91.61,59.224.25.175
CORS_ALLOWED_ORIGINS=http://59.224.25.175:2080,http://172.29.91.61:80
```

**注意**：等号两边不要有空格，多个值用逗号分隔，不要有空格。

### 步骤3：重启后端服务
```bash
# 方法1：如果使用systemd
sudo systemctl restart gunicorn

# 方法2：如果使用supervisor
sudo supervisorctl restart oms_backend

# 方法3：如果直接运行，先找到进程
ps aux | grep gunicorn
kill -HUP <进程ID>
# 然后重新启动
cd /home/zxy_8581/OMS/backend
source venv/bin/activate
gunicorn oms_backend.wsgi:application --bind 127.0.0.1:8000 --workers 3
```

### 步骤4：清除浏览器缓存并重试
- 按 `Ctrl+Shift+Delete` 清除缓存
- 或使用无痕模式测试登录

## 验证是否修复成功

打开浏览器开发者工具（F12），尝试登录：
- ✅ 成功：Network标签页中 `/api/auth/login/` 返回200或401
- ❌ 失败：返回403或CORS错误 → 检查配置是否正确，服务是否重启

## 详细说明
- Nginx配置问题：查看 `docs/Nginx配置问题分析与修复.md`
- 后端配置问题：查看 `docs/生产环境登录问题修复方案.md`

