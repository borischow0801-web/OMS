# 日志权限问题修复方案

## 问题分析

错误日志显示：
```
PermissionError: [Errno 13] Permission denied: '/var/log/oms/backend-error.log'
```

**根本原因**：Gunicorn 进程以 `nginx` 用户运行，但日志目录 `/var/log/oms/` 的所有者或权限不正确，导致无法写入日志文件。

## 立即修复步骤

### 步骤 1：创建日志目录（如果不存在）

```bash
sudo mkdir -p /var/log/oms
```

### 步骤 2：设置日志目录的所有者和权限

```bash
# 设置所有者为 nginx 用户和组
sudo chown -R nginx:nginx /var/log/oms

# 设置权限（目录需要有执行权限才能访问）
sudo chmod -R 755 /var/log/oms
```

### 步骤 3：验证权限设置

```bash
# 检查目录权限
ls -la /var/log/ | grep oms

# 应该看到类似：
# drwxr-xr-x  2 nginx nginx 4096 Dec  7 16:55 oms
```

### 步骤 4：测试 nginx 用户是否可以写入

```bash
# 测试写入权限（以 nginx 用户身份）
sudo -u nginx touch /var/log/oms/test.log
sudo -u nginx rm /var/log/oms/test.log

# 如果上述命令成功，说明权限设置正确
```

### 步骤 5：重启后端服务

```bash
sudo systemctl restart oms-backend

# 等待几秒后检查状态
sleep 3
sudo systemctl status oms-backend
```

### 步骤 6：验证日志文件已创建

```bash
# 检查日志文件是否存在
ls -la /var/log/oms/

# 应该看到：
# -rw-r--r-- 1 nginx nginx xxxx backend-access.log
# -rw-r--r-- 1 nginx nginx xxxx backend-error.log
```

### 步骤 7：查看最新日志，确认没有权限错误

```bash
sudo journalctl -u oms-backend.service -n 20 --no-pager
```

## 完整的修复命令（一键执行）

```bash
#!/bin/bash

echo "=== 修复日志权限问题 ==="

# 1. 创建日志目录
sudo mkdir -p /var/log/oms
echo "✅ 日志目录已创建"

# 2. 设置所有者和权限
sudo chown -R nginx:nginx /var/log/oms
sudo chmod -R 755 /var/log/oms
echo "✅ 权限已设置"

# 3. 验证权限
if sudo -u nginx touch /var/log/oms/test.log 2>/dev/null; then
    sudo -u nginx rm /var/log/oms/test.log
    echo "✅ 权限验证通过"
else
    echo "❌ 权限验证失败，请检查 nginx 用户是否存在"
    exit 1
fi

# 4. 重启服务
echo ""
echo "重启后端服务..."
sudo systemctl restart oms-backend
sleep 3

# 5. 检查服务状态
if sudo systemctl is-active --quiet oms-backend; then
    echo "✅ 后端服务运行正常"
else
    echo "❌ 后端服务启动失败"
    echo ""
    echo "查看最新日志："
    sudo journalctl -u oms-backend.service -n 20 --no-pager
    exit 1
fi

# 6. 检查日志文件
echo ""
echo "检查日志文件："
ls -la /var/log/oms/

echo ""
echo "=== 修复完成 ==="
```

保存为 `fix_log_permissions.sh`，然后运行：

```bash
chmod +x fix_log_permissions.sh
sudo ./fix_log_permissions.sh
```

## 验证修复是否成功

### 1. 检查服务状态

```bash
sudo systemctl status oms-backend
```

应该显示 `active (running)`，没有权限错误。

### 2. 查看最新日志

```bash
sudo journalctl -u oms-backend.service -n 20 --no-pager
```

**不应该**再看到 `PermissionError` 或 `Permission denied` 错误。

### 3. 检查日志文件

```bash
ls -la /var/log/oms/
tail -n 20 /var/log/oms/backend-error.log
```

日志文件应该存在且可以正常写入。

### 4. 测试 API

```bash
# 测试登录接口
curl -X POST http://127.0.0.1:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"你的管理员用户名","password":"你的密码"}'
```

### 5. 访问管理员后台

在浏览器中访问：`http://172.29.91.61/admin/`

应该可以正常访问，不再出现 500 错误。

## 常见问题

### Q1: 如果 nginx 用户不存在怎么办？

```bash
# 检查 nginx 用户是否存在
id nginx

# 如果不存在，创建 nginx 用户
sudo useradd -r -s /sbin/nologin nginx
```

### Q2: 如果还是权限不足怎么办？

可以尝试更宽松的权限（不推荐用于生产环境，但可以临时测试）：

```bash
sudo chmod -R 777 /var/log/oms
```

### Q3: SELinux 导致的权限问题

如果系统启用了 SELinux，可能需要设置 SELinux 上下文：

```bash
# 检查 SELinux 状态
getenforce

# 如果启用了 SELinux，设置正确的上下文
sudo chcon -R -t httpd_log_t /var/log/oms/
```

### Q4: 日志目录权限被重置

如果权限经常被重置，可以设置 ACL（访问控制列表）来持久化权限：

```bash
# 安装 ACL 工具（如果未安装）
sudo yum install -y acl  # CentOS/RHEL
# 或
sudo apt install -y acl  # Ubuntu/Debian

# 设置 ACL
sudo setfacl -R -m u:nginx:rwx /var/log/oms/
sudo setfacl -R -d -m u:nginx:rwx /var/log/oms/  # 默认权限
```

## 预防措施

### 1. 在部署脚本中自动设置权限

在部署时自动设置正确的权限，避免手动操作。

### 2. 使用 systemd 日志（替代文件日志）

可以考虑使用 systemd 的 journald 来记录日志，避免文件权限问题：

修改 systemd 服务文件，移除文件日志配置，直接使用 journalctl 查看日志。

## 总结

**问题根源**：日志目录 `/var/log/oms/` 的权限设置不正确，nginx 用户无法写入。

**解决方法**：
1. 确保日志目录存在
2. 设置正确的所有者和权限：`sudo chown -R nginx:nginx /var/log/oms && sudo chmod -R 755 /var/log/oms`
3. 重启后端服务

**验证方法**：
- 服务状态正常
- 日志中没有权限错误
- API 可以正常访问
- 管理员后台可以正常访问

