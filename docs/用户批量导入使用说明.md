# 用户批量导入功能使用说明

## 功能概述

用户批量导入功能允许管理员通过Excel文件批量导入用户到系统中，大大提高用户管理的效率。

## 使用步骤

### 第一步：生成导入模板

在首次使用前，需要先生成导入模板文件。有两种方式：

#### 方式一：使用Django管理命令（推荐）

```bash
cd /home/zxy_8581/OMS/backend
source venv/bin/activate
python manage.py generate_user_template
```

命令执行后，模板文件将生成在 `OMS/docs/用户导入模板.xlsx`

#### 方式二：在后台管理界面下载

1. 登录Django后台管理界面
2. 进入"用户"管理页面
3. 点击"批量导入用户"按钮
4. 在导入页面点击"下载导入模板"按钮

### 第二步：填写用户信息

打开下载的Excel模板文件，按照以下要求填写用户信息：

#### 必需字段

- **用户名**：必填，唯一，不能与现有用户重复
- **密码**：必填，至少8个字符

#### 可选字段

- **姓名**：用户显示名称
- **邮箱**：可选，如果填写则必须唯一
- **角色**：可选，可选值为：
  - `使用方`（默认）
  - `管理方`
  - `承建方-项目经理`
  - `承建方-员工`
- **手机号**：可选
- **部门**：可选

#### 填写示例

模板文件中已包含示例数据，可以直接参考：

| 用户名 | 密码 | 姓名 | 邮箱 | 角色 | 手机号 | 部门 |
|--------|------|------|------|------|--------|------|
| zhangsan | 12345678 | 张三 | zhangsan@example.com | 使用方 | 13800138000 | 信息中心 |
| lisi | 12345678 | 李四 | lisi@example.com | 管理方 | 13800138001 | 办公室 |

### 第三步：上传导入

1. 登录Django后台管理界面
2. 进入"用户"管理页面
3. 点击"批量导入用户"按钮
4. 在导入页面：
   - 点击"下载导入模板"（如需要）
   - 选择填写好的Excel文件
   - 点击"开始导入"按钮

### 第四步：查看导入结果

导入完成后，系统会显示导入结果：

- **成功数量**：成功导入的用户数量
- **失败数量**：导入失败的用户数量
- **错误信息**：详细的错误提示（最多显示10条）
- **导入详情**：每条记录的导入状态（最多显示20条）

## 注意事项

### 文件格式要求

- 文件格式必须是Excel文件（.xlsx或.xls）
- 必须使用提供的模板文件格式
- 表头必须与模板保持一致

### 数据验证规则

1. **用户名**
   - 不能为空
   - 长度不能超过150个字符
   - 不能与现有用户重复

2. **密码**
   - 不能为空
   - 长度至少8个字符

3. **邮箱**
   - 如果填写，必须符合邮箱格式
   - 不能与现有用户重复

4. **角色**
   - 必须从提供的选项中选择
   - 如果不填写，默认为"使用方"

### 导入行为

- 如果Excel文件中存在数据验证错误，所有记录都不会被导入
- 只有所有数据验证通过后，才会执行导入操作
- 导入操作使用数据库事务，确保数据一致性
- 如果导入过程中发生错误，会回滚所有更改

### 错误处理

如果导入失败，系统会提供详细的错误信息：

- 错误信息会明确指出是第几行数据有问题
- 会说明具体的错误原因
- 最多显示10条错误信息（如果错误较多）

常见错误及解决方法：

1. **用户名已存在**：修改用户名或删除已存在的用户
2. **密码长度不足**：确保密码至少8个字符
3. **邮箱格式错误**：检查邮箱格式是否正确
4. **角色无效**：从下拉列表中选择有效的角色值

## 技术实现

### 依赖库

- `openpyxl==3.1.2`：用于处理Excel文件

### 相关文件

- `backend/apps/accounts/import_service.py`：导入服务核心逻辑
- `backend/apps/accounts/admin.py`：Django Admin集成
- `backend/apps/accounts/management/commands/generate_user_template.py`：模板生成命令
- `backend/apps/accounts/templates/admin/accounts/user/import.html`：导入页面模板
- `docs/用户导入模板.xlsx`：导入模板文件

### 安装依赖

如果尚未安装openpyxl，需要先安装：

```bash
cd /home/zxy_8581/OMS/backend
source venv/bin/activate
pip install openpyxl==3.1.2
```

或者安装所有依赖：

```bash
pip install -r requirements.txt
```

## 常见问题

### Q1: 如何批量更新现有用户？

A: 当前版本仅支持批量导入新用户。如果要更新现有用户，请在后台管理界面手动编辑，或等待后续版本支持批量更新功能。

### Q2: 导入大量用户时，系统会变慢吗？

A: 导入操作在数据库事务中执行，如果导入大量用户（如超过1000个），可能会影响系统性能。建议分批导入，每批不超过500个用户。

### Q3: 可以导入重复的用户吗？

A: 不可以。用户名和邮箱必须唯一。如果Excel中包含重复的用户名或邮箱，导入会失败并提示错误。

### Q4: 导入的用户的默认状态是什么？

A: 所有导入的用户默认状态为"激活"（is_active=True），可以立即使用。

### Q5: 模板文件可以修改吗？

A: 可以修改，但请保持表头格式不变。可以添加或删除数据行，但不要修改第一行（表头）和第二行（说明）。

---

**文档版本：** v1.0  
**创建日期：** 2025-01-XX  
**最后更新：** 2025-01-XX

