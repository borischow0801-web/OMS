# 前端构建问题解决方案

## 问题描述

在麒麟V10服务器上使用 Node.js v24.11.1 构建前端时出现错误：
```
Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/opt/OMS/frontend-pc/node_modules/dist/node/cli.js' 
imported from /opt/OMS/frontend-pc/node_modules/.bin/vite
```

## 原因分析

Node.js v24.11.1 版本过新，可能与我们当前使用的 vite 5.0.8 存在兼容性问题，或者 node_modules 安装不完整。

## 解决方案

### 方案一：清理并重新安装依赖（推荐优先尝试）

在服务器上执行以下命令：

```bash
cd /opt/OMS/frontend-pc

# 1. 删除 node_modules 和 package-lock.json
rm -rf node_modules package-lock.json

# 2. 清理 npm 缓存
npm cache clean --force

# 3. 重新安装依赖
npm install

# 4. 再次尝试构建
npm run build
```

### 方案二：升级 Vite 到最新版本（如果方案一失败）

如果方案一仍然失败，可以尝试升级 Vite 和相关插件到更新的版本，以获得更好的 Node.js 24 支持。

**需要修改的文件：`frontend-pc/package.json`**

将以下依赖版本更新：

```json
"devDependencies": {
  "@types/react": "^18.2.43",
  "@types/react-dom": "^18.2.17",
  "@vitejs/plugin-react": "^4.2.1",
  "vite": "^5.1.0",  // 从 ^5.0.8 升级到 ^5.1.0 或更高
  "eslint": "^8.55.0",
  "eslint-plugin-react": "^7.33.2",
  "eslint-plugin-react-hooks": "^4.6.0",
  "eslint-plugin-react-refresh": "^0.4.5"
}
```

然后在服务器上执行：

```bash
cd /opt/OMS/frontend-pc
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
npm run build
```

### 方案三：使用 Node.js 18 或 20 LTS 版本（最稳定）

如果上述方案都不行，建议在生产环境使用 Node.js 18 或 20 LTS 版本，这些版本经过充分测试，与现有工具链兼容性更好。

#### 使用 nvm 管理 Node.js 版本（推荐）

如果服务器已安装 nvm：

```bash
# 查看已安装的版本
nvm list

# 安装 Node.js 20 LTS
nvm install 20

# 切换到 Node.js 20
nvm use 20

# 验证版本
node --version  # 应该显示 v20.x.x

# 然后重新安装依赖并构建
cd /opt/OMS/frontend-pc
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
npm run build
```

#### 直接安装 Node.js 20 LTS

如果没有 nvm，可以卸载当前版本并安装 Node.js 20：

```bash
# 卸载当前 Node.js（根据实际安装方式调整）
# 如果使用 NodeSource 安装的：
sudo apt remove nodejs npm

# 安装 Node.js 20 LTS
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 验证版本
node --version  # 应该显示 v20.x.x
npm --version

# 重新安装依赖并构建
cd /opt/OMS/frontend-pc
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
npm run build
```

## 推荐方案优先级

1. **优先尝试方案一**：最简单，通常可以解决问题
2. **如果方案一失败，尝试方案二**：升级 Vite 版本
3. **如果方案二也失败，使用方案三**：降级到 Node.js 20 LTS（最稳定）

## 注意事项

1. 在修改 `package.json` 之前，建议先备份
2. 如果使用方案二，修改后记得提交代码更改
3. 使用方案三时，确保团队其他成员也使用相同的 Node.js 版本，避免开发环境和生产环境不一致

## 验证构建成功

构建成功后，应该会在 `frontend-pc/dist` 目录下生成静态文件。可以检查：

```bash
ls -la /opt/OMS/frontend-pc/dist
```

如果看到 `index.html` 和其他静态资源文件，说明构建成功。

## 常见问题解答

### Q1: npm install 后出现 deprecated 警告怎么办？

**A:** 这些警告是正常的，不会影响功能。这些包是依赖项的间接依赖，主要警告包括：
- `inflight@1.0.6`: 已废弃，但仍在某些工具链中使用
- `glob@7.2.3`: 旧版本，某些依赖仍在使用
- `rimraf@3.0.2`: 旧版本，某些依赖仍在使用
- `eslint@8.57.1`: 已废弃，但项目中使用的是 `^8.55.0`，可以继续使用

这些警告可以暂时忽略，它们不会影响构建和运行。如果后续需要，可以升级相关依赖。

### Q2: npm install 后提示有安全漏洞怎么办？

**A:** 如果提示有安全漏洞（如 "2 moderate severity vulnerabilities"），可以按以下方式处理：

1. **查看详细信息**（可选）：
   ```bash
   npm audit
   ```

2. **自动修复**（谨慎使用，可能会升级依赖导致不兼容）：
   ```bash
   npm audit fix
   ```

3. **如果自动修复失败，可以强制修复**（可能破坏兼容性，不推荐在生产环境立即使用）：
   ```bash
   npm audit fix --force
   ```

4. **建议做法**：
   - 如果只是 `moderate`（中等）严重性，且不影响生产环境，可以先继续构建
   - 后续有时间时，逐步升级相关依赖到最新版本
   - 定期运行 `npm audit` 检查安全漏洞

### Q3: 安装成功后的下一步是什么？

**A:** 安装成功后，继续执行构建命令：

```bash
npm run build
```

如果构建成功，会在 `dist` 目录下生成生产环境的静态文件。

### Q4: 如何升级依赖以消除警告？

**A:** 如果想升级依赖以消除警告，可以逐步升级（建议在本地测试环境先测试）：

1. **升级 ESLint 到 9.x**（注意：可能有破坏性更改）：
   - 需要将 `eslint` 从 `^8.55.0` 升级到 `^9.0.0`
   - 可能需要更新 ESLint 配置文件格式

2. **升级 Vite 和相关插件**（推荐，相对安全）：
   - `vite`: `^5.0.8` → `^5.1.0` 或更高
   - `@vitejs/plugin-react`: `^4.2.1` → `^4.3.0` 或更高

**注意**：升级前建议：
- 在本地开发环境先测试
- 查看各包的更新日志，了解破坏性更改
- 逐步升级，不要一次性升级所有包

