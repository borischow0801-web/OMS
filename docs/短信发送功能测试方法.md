# 短信发送功能测试方法

## 问题修复说明

### 修复内容

1. **修正成功判断逻辑**：
   - 之前只判断 HTTP 状态码是否为 200
   - 现在正确检查响应体中的 `state` 字段是否为 "200"，且 `error` 字段为空
   - 正常返回应该是：`{"state": "200", "error": ""}`

2. **修改请求方式为 POST（参数在URL查询字符串中）**：
   - 使用 POST 请求，但参数通过 URL 查询字符串传递（不是 JSON body）
   - 接口格式：`http://59.224.26.72:8086/web/approval/sendMessage?phoneNum=18353248009&mesConent=测试&regionCode=371000000000&source=oms`
   - `regionCode` 和 `source` 可以写死为固定值（默认：regionCode=371000000000, source=oms）
   - 支持参数配置和占位符替换

3. **防止重复发送**：
   - 检查短时间内（默认5分钟）是否已发送过相同的短信
   - 基于任务ID、模板类型、接收人进行判断
   - 使用数据库事务和双重检查避免并发重复发送
   - 防止死循环重复发送

4. **增强日志记录**：
   - 记录完整的请求 URL（包含所有查询参数）
   - 记录响应状态码、响应体内容
   - 日志格式：`[短信发送请求]` 和 `[短信发送响应]`

## 测试方法

### 方法 1：使用管理命令测试（推荐）

#### 测试直接发送短信

```bash
cd /opt/OMS/backend
source venv/bin/activate

# 直接发送短信
python manage.py test_sms --phone 13800138000 --content "这是一条测试短信"
```

#### 测试使用模板发送短信

```bash
# 使用任务提交模板发送（需要任务ID）
python manage.py test_sms --phone 13800138000 --template task_submitted --task-id 1

# 使用任务审核通过模板发送（需要任务ID和接收人ID）
python manage.py test_sms --phone 13800138000 --template task_reviewed --task-id 1 --user-id 2
```

**参数说明：**
- `--phone`: 接收短信的手机号（必填）
- `--content`: 短信内容（直接发送时必填）
- `--template`: 模板类型（使用模板时必填）
  - `task_submitted`: 任务提交
  - `task_reviewed`: 任务审核通过
  - `task_reviewed_rejected`: 任务审核不通过
  - `task_assigned`: 任务分配
  - `task_completed`: 任务完成
  - `task_needs_modification`: 任务需要修改
- `--task-id`: 任务ID（使用模板时必填）
- `--user-id`: 接收人用户ID（使用模板时可选）

### 方法 2：在 Django Admin 中测试

1. **配置短信接口**：
   - 访问：`http://你的服务器地址/admin/workflow/smsconfig/`
   - 确保有启用的短信配置
   - **接口 URL**：填写基础 URL，例如：`http://59.224.26.72:8086/web/approval/sendMessage`
   - **接口参数模板**（可选）：JSON 格式，例如：
     ```json
     {
       "phoneNum": "{phone}",
       "mesConent": "{content}",
       "regionCode": "371000000000",
       "source": "oms"
     }
     ```
   - 参数说明：
     - `{phone}` 会被替换为实际手机号
     - `{content}` 会被替换为实际短信内容
     - `regionCode` 和 `source` 可以写死为固定值
   - **如果不配置参数模板**，系统会使用默认值：
     - `phoneNum`: 动态值（手机号）
     - `mesConent`: 动态值（短信内容）
     - `regionCode`: 固定值 `371000000000`
     - `source`: 固定值 `oms`

2. **测试发送**：
   - 访问：`http://你的服务器地址/admin/workflow/smsrecord/`
   - 可以查看历史发送记录
   - 对于失败的记录，可以点击"重发"按钮进行重试

### 方法 3：在任务流程中触发（真实场景）

1. **创建任务并提交**：
   - 在前端创建任务并提交
   - 系统会自动发送任务提交短信给管理方

2. **审核任务**：
   - 管理方审核任务
   - 系统会自动发送审核结果短信

3. **查看短信记录**：
   - 访问：`http://你的服务器地址/admin/workflow/smsrecord/`
   - 查看发送状态和详细日志

## 查看日志

### 方式 1：查看 Gunicorn 日志（推荐）

```bash
# 实时查看日志
sudo journalctl -u oms-backend -f

# 查看最近 100 行日志
sudo journalctl -u oms-backend -n 100

# 查看最近 10 分钟的日志
sudo journalctl -u oms-backend --since "10 minutes ago"
```

### 方式 2：查看 Django 日志文件

如果配置了文件日志，可以查看日志文件：

```bash
# 查看日志文件（根据实际配置调整路径）
tail -f /opt/OMS/logs/django.log
```

### 方式 3：在 Django Admin 中查看

访问短信发送记录页面，点击记录可以查看：
- 请求参数（在日志中）
- 响应内容
- 错误信息

## 日志格式说明

### 请求日志格式

```
[短信发送请求] 手机号: 13800138000, 请求方式: POST, 完整URL: http://59.224.26.72:8086/web/approval/sendMessage?phoneNum=13800138000&mesConent=测试内容&regionCode=371000000000&source=oms, 查询参数: {"phoneNum":"13800138000","mesConent":"测试内容","regionCode":"371000000000","source":"oms"}
```

### 响应日志格式

```
[短信发送响应] 记录ID: 123, 手机号: 13800138000, HTTP状态码: 200, 响应内容: {"code":"200"}
```

### 重复发送检查日志格式

```
[重复发送检查] 手机号: 13800138000, 任务ID: 1, 模板类型: task_submitted, 在最近5分钟内已发送过相同短信，跳过发送
```

### 成功日志格式

```
[短信发送成功] 记录ID: 123, 手机号: 13800138000, code: 200
```

### 失败日志格式

```
[短信发送失败] 记录ID: 123, 手机号: 13800138000, 原因: 短信接口返回失败: code=300
```

## 常见问题排查

### 问题 1：返回 `{"code": "300", "error": "未获取发送短信返回结果参数"}`

**原因**：接口参数格式不正确或缺少必要参数

**排查步骤**：
1. 检查日志中的完整 URL，确认查询参数是否正确
2. 检查短信配置中的参数模板是否正确：
   - 参数名是否正确（phoneNum、mesConent 等）
   - 占位符是否正确（{phone}、{content}）
   - 固定参数（regionCode、source）是否正确
3. 确认接口 URL 是否正确（基础 URL，不包含查询参数）
4. 检查参数值是否正确 URL 编码（中文等特殊字符）
5. 联系接口提供方确认参数格式

### 问题 4：短信重复发送

**原因**：可能存在死循环或并发重复发送

**解决方案**：
1. 系统已内置防重复发送机制：
   - 检查 5 分钟内是否已发送过相同的短信
   - 基于任务ID、模板类型、接收人判断
   - 使用数据库事务避免并发问题
2. 如果仍然重复发送，检查：
   - 是否有多个地方同时调用发送短信
   - 是否有定时任务重复触发
   - 查看日志中的重复发送检查记录

### 问题 2：HTTP 状态码 200 但 state 不是 "200"

**原因**：接口返回的业务错误

**排查步骤**：
1. 查看日志中的响应内容
2. 根据 `error` 字段的错误信息排查
3. 检查请求参数是否符合接口要求

### 问题 3：请求超时

**原因**：网络问题或接口响应慢

**排查步骤**：
1. 检查网络连接
2. 检查接口服务是否正常
3. 可以适当增加超时时间（在 `sms_service.py` 中修改 `timeout` 参数）

## 验证修复

修复后，系统会：

1. ✅ **正确判断成功**：只有当 `state="200"` 且 `error=""` 时才标记为成功
2. ✅ **详细记录日志**：所有请求参数和响应内容都记录到日志
3. ✅ **便于追踪问题**：通过日志可以清楚看到发送过程和错误原因

## 测试检查清单

- [ ] 使用管理命令发送测试短信成功
- [ ] 日志中正确记录了请求参数
- [ ] 日志中正确记录了响应内容
- [ ] 返回 `{"state": "200", "error": ""}` 时标记为成功
- [ ] 返回 `{"code": "300", "error": "xxx"}` 时标记为失败
- [ ] 在 Django Admin 中可以查看完整的请求和响应信息
- [ ] 任务流程中触发的短信发送正常

## 注意事项

1. **手机号格式**：确保手机号格式正确，不要包含空格或特殊字符
2. **短信内容长度**：注意短信内容长度限制（通常 70 个字符以内为单条短信）
3. **接口限制**：注意短信接口的调用频率限制，避免频繁调用导致被限制
4. **日志大小**：定期清理日志文件，避免日志文件过大影响性能

